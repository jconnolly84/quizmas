<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quizmas Team</title>
  <link rel="stylesheet" href="./app.css" />
</head>
<body>
  <div class="wrap">
    <h1>Team Buzzer</h1>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>Room code</label><br/>
          <input id="room" placeholder="e.g. quizmas" />
        </div>
        <div class="col">
          <label>Team name</label><br/>
          <input id="team" placeholder="e.g. The Sprouts" />
        </div>
      </div>
      <button id="join">Join</button>
      <p class="small" id="status"></p>
    </div>

    <div class="card" id="live" style="display:none;">
      
      <div class="card" style="background:#0f1627;">
        <div class="small" id="teamMeta">â€”</div>
        <div class="big" id="teamPrompt">â€”</div>
        <div id="teamOptions" class="small" style="margin-top:8px;"></div>
        <div id="teamReveal" class="small" style="margin-top:10px; display:none;"></div>
      </div>

      <div class="big" id="state">Ready</div>
      <p class="small" id="info"></p>
      <button class="buzz" id="buzzBtn">BUZZ!</button>
    </div>
  </div>

  <script type="module">
    import { ensureRoom, listenRoom, buzz, registerTeam } from "./common.js";
    const $ = (id) => document.getElementById(id);

    let roomId = null;
    let teamName = null;
    let unsub = null;

    $("join").onclick = async () => {
      roomId = $("room").value.trim();
      teamName = $("team").value.trim();
      if (!roomId || !teamName) {
        $("status").textContent = "Enter room + team name.";
        return;
      }

      $("status").textContent = "Joiningâ€¦";
      await ensureRoom(roomId);
      await registerTeam(roomId, teamName);

      $("live").style.display = "block";
      $("status").textContent = `Joined room: ${roomId}`;

      if (unsub) unsub();
      unsub = listenRoom(roomId, (data) => {
        const round = data?.game?.round ?? null;

        // Default buzz UI (works for all rounds)
        const lockedBy = data?.buzz?.lockedBy ?? null;
        if (!lockedBy) {
          $("buzzBtn").disabled = false;
          $("buzzBtn").textContent = "BUZZ!";
        } else {
          $("buzzBtn").disabled = true;
          $("buzzBtn").textContent = "LOCKED";
        }


        const liveQ = data?.live || null;
        const reveal = !!data?.reveal;

        if (liveQ) {
          $("teamMeta").textContent = `${liveQ.roundId.toUpperCase()} â€¢ Q${(liveQ.index ?? 0) + 1}`;
          $("teamPrompt").textContent = liveQ.prompt || "â€”";

          if (liveQ.roundType === "mcq" && Array.isArray(liveQ.options)) {
            $("teamOptions").innerHTML = liveQ.options
              .map((o,i)=>`<div><strong>${String.fromCharCode(65+i)}.</strong> ${o}</div>`)
              .join("");
          } else {
            $("teamOptions").textContent = "";
          }

          if (reveal) {
            $("teamReveal").style.display = "block";
            $("teamReveal").textContent = `Answer: ${liveQ.answer ?? "â€”"}`;
          } else {
            $("teamReveal").style.display = "none";
          }
        }


        // Charades behaviour
        if (round === "charades") {
          const ch = data?.charades ?? {};
          if (ch.actorTeam === teamName) {
            $("state").textContent = "ACT IT OUT ðŸŽ­";
            $("info").textContent = ch.person ? `Your person: ${ch.person}` : "Waiting for hostâ€¦";
            $("buzzBtn").disabled = true; // acting team shouldn't buzz
            $("buzzBtn").textContent = "ACTING";
          } else {
            $("state").textContent = "GUESS!";
            $("info").textContent = ch.actorTeam ? `Acting team: ${ch.actorTeam}` : "Waiting for hostâ€¦";
            // guessing teams can still buzz (optional). Keep enabled if buzz is open.
          }
          return;
        }

        // Normal buzzer feedback (non-charades)
        if (!lockedBy) {
          $("state").textContent = "Ready";
          $("info").textContent = "Buzz is open.";
          return;
        }

        if (lockedBy === teamName) {
          $("state").textContent = "YOU WON âœ…";
          $("info").textContent = "Wait for host to reset.";
        } else {
          $("state").textContent = "TOO LATE â›”";
          $("info").textContent = `Locked by: ${lockedBy}`;
        }
      });
    };

    $("buzzBtn").onclick = async () => {
      if (!roomId || !teamName) return;
      await buzz(roomId, teamName);
    };
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quizmas Host</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b1020;color:#e9eefc}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:8px 0 16px}
    .card{background:#121a33;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px;margin:10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .col{flex:1;min-width:220px}
    label{opacity:.85}
    input,select,button{font:inherit}
    input,select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0f1627;color:#e9eefc;width:100%}
    button{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#1a2550;color:#e9eefc;cursor:pointer}
    button:hover{filter:brightness(1.05)}
    .small{font-size:.9rem;opacity:.85}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0f1627;border:1px solid rgba(255,255,255,.12)}
    details summary{cursor:pointer}
    table{width:100%;border-collapse:collapse}
    td,th{padding:8px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    .right{text-align:right}
    .winner{font-size:1.4rem;font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸŽ„ Quizmas â€“ Host</h1>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>Room code</label>
          <input id="room" placeholder="e.g. quiz1" />
        </div>
        <div class="col" style="display:flex;gap:10px;align-items:flex-end;justify-content:flex-end;">
          <button id="open">Open / Create Room</button>
          <button id="resetBuzzBtn">Reset Buzz</button>
        </div>
      </div>
      <div id="status" class="small" style="margin-top:8px;">Not connected.</div>
    </div>

    <div id="main" style="display:none;">
      <div class="card">
        <div class="row">
          <div class="col">
            <div class="small">First buzz</div>
            <div class="winner" id="winner">â€”</div>
            <div class="small" id="awardHint">Award points to: (no buzz yet)</div>
          </div>
          <div class="col right">
            <span class="pill" id="modePill">Mode: Buzzer</span>
          </div>
        </div>
      </div>

      <details id="scoresDetails" open>
        <summary><strong>Scores</strong> <span class="small">(tap to collapse)</span></summary>
        <div class="card">
          <table>
            <thead><tr><th>Team</th><th class="right">Score</th><th class="right">Adjust</th></tr></thead>
            <tbody id="scoresBody"></tbody>
          </table>
        </div>
      </details>

      <details id="charadesDetails">
        <summary><strong>Charades (Sherards)</strong> <span class="small">(tap to collapse)</span></summary>
        <div class="card">
          <div class="row">
            <div class="col">
              <label>Actor team</label>
              <select id="actorTeam"></select>
            </div>
            <div class="col">
              <label>Seconds</label>
              <input id="charSeconds" type="number" min="10" value="60"/>
            </div>
            <div class="col" style="display:flex;gap:10px;justify-content:flex-end;align-items:flex-end;">
              <button id="startCharadesBtn">Start</button>
              <button id="stopCharadesBtn">Stop</button>
              <button id="revealCharadesBtn">Reveal</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col">
              <div class="small">Timer</div>
              <div class="winner" id="charTimer">â€”</div>
              <div class="small">Person is hidden from host until Reveal.</div>
            </div>
            <div class="col right">
              <button id="awardMinus1">-1</button>
              <button id="awardPlus1">+1</button>
              <button id="awardPlus2">+2</button>
            </div>
          </div>

          <div id="charRevealBox" class="card" style="display:none;margin-top:10px;background:#0f1627;">
            <div class="small">Reveal</div>
            <div class="winner" id="charPerson">â€”</div>
          </div>
        </div>
      </details>
    </div>
  </div>

  <script type="module">
    import {
      ensureRoom,
      listenRoom,
      resetBuzz,
      changeScore,
      startCharades,
      stopCharades,
      revealCharades
    } from "./common.js";

    const $ = (id) => document.getElementById(id);

    let roomId = null;
    let unsub = null;
    let latest = null;
    let timerInt = null;

    function modePill(data){
      const round = data?.game?.round ?? null;
      return round === "charades" ? "Mode: Charades" : "Mode: Buzzer";
    }

    function renderTeamsSelect(teams){
      const sel = $("actorTeam");
      const list = Array.isArray(teams) ? teams : [];
      sel.innerHTML = list.map(t => `<option value="${t}">${t}</option>`).join("");
    }

    function renderScores(scores){
      const body = $("scoresBody");
      body.innerHTML = "";
      const entries = Object.entries(scores || {}).sort((a,b)=>b[1]-a[1]);
      for (const [team, score] of entries){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${team}</td>
          <td class="right">${Number(score)}</td>
          <td class="right">
            <button data-team="${team}" data-d="-1">-1</button>
            <button data-team="${team}" data-d="1">+1</button>
            <button data-team="${team}" data-d="2">+2</button>
          </td>
        `;
        body.appendChild(tr);
      }
      body.querySelectorAll("button[data-team]").forEach(btn=>{
        btn.onclick = async () => {
          if (!roomId) return;
          const team = btn.getAttribute("data-team");
          const d = Number(btn.getAttribute("data-d"));
          await changeScore(roomId, team, d);
        };
      });
    }

    function startTimer(endsAt){
      if (timerInt) clearInterval(timerInt);
      const tick = () => {
        const now = Date.now();
        const ms = Math.max(0, (endsAt||0) - now);
        const s = Math.ceil(ms/1000);
        $("charTimer").textContent = endsAt ? `${s}s` : "â€”";
        if (ms <= 0) {
          clearInterval(timerInt);
          timerInt = null;
        }
      };
      tick();
      timerInt = setInterval(tick, 250);
    }

    function renderCharades(c){
      const round = latest?.game?.round ?? null;
      const show = round === "charades";
      $("charadesDetails").open = show;
      $("scoresDetails").open = !show;
      $("modePill").textContent = modePill(latest);

      const endsAt = c?.endsAt ?? null;
      startTimer(endsAt);

      const revealed = !!c?.revealed;
      $("charRevealBox").style.display = revealed ? "block" : "none";
      $("charPerson").textContent = revealed ? (c?.person || "â€”") : "â€”";
    }

    function renderBuzzer(b){
      const lockedBy = b?.lockedBy ?? null;
      $("winner").textContent = lockedBy || "â€”";
      $("awardHint").textContent = lockedBy ? `Award points to: ${lockedBy}` : "Award points to: (no buzz yet)";
    }

    async function awardToBuzzWinner(delta){
      const winner = latest?.buzz?.lockedBy || null;
      if (!winner) return alert("No team has buzzed in yet.");
      await changeScore(roomId, winner, delta);
    }

    $("open").onclick = async () => {
      roomId = $("room").value.trim();
      if (!roomId) { $("status").textContent = "Enter a room code."; return; }

      $("status").textContent = "Opening roomâ€¦";
      try{
        await ensureRoom(roomId);
      }catch(e){
        $("status").textContent = "Failed to create room (check Firebase config / console).";
        console.error(e);
        return;
      }

      $("main").style.display = "block";
      $("status").textContent = `Room ready: ${roomId}`;

      if (unsub) unsub();
      unsub = listenRoom(roomId, (data) => {
        latest = data || {};
        renderBuzzer(latest.buzz);
        renderTeamsSelect(latest.teams);
        renderScores(latest.scores);
        renderCharades(latest.charades);
      });
    };

    $("resetBuzzBtn").onclick = async () => { if (roomId) await resetBuzz(roomId); };

    $("startCharadesBtn").onclick = async () => {
      if (!roomId) return;
      const team = $("actorTeam").value;
      const seconds = Number($("charSeconds").value || 60);
      // pick random person from a built-in list (teams will see it)
      const people = [
        "David Attenborough","Taylor Swift","Mr Bean","The Queen (historical)","Albert Einstein",
        "The Grinch","Darth Vader","Harry Potter","Elsa (Frozen)","Gordon Ramsay",
        "Donald Trump","Boris Johnson","The Easter Bunny","Santa","A confused penguin"
      ];
      const person = people[Math.floor(Math.random()*people.length)];
      await startCharades(roomId, team, person, seconds);
    };

    $("stopCharadesBtn").onclick = async () => { if (roomId) await stopCharades(roomId); };
    $("revealCharadesBtn").onclick = async () => { if (roomId) await revealCharades(roomId); };

    $("awardMinus1").onclick = async () => { if (roomId) await awardToBuzzWinner(-1); };
    $("awardPlus1").onclick = async () => { if (roomId) await awardToBuzzWinner(1); };
    $("awardPlus2").onclick = async () => { if (roomId) await awardToBuzzWinner(2); };
  </script>
</body>
</html>

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quizmas Host</title>
  <link rel="stylesheet" href="./app.css" />
</head>
<body>
  <div class="wrap">
    <h1>Host Console</h1>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>Room code</label><br/>
          <input id="room" placeholder="e.g. quizmas" />
        </div>
        <div class="col">
          <button id="open">Open / Create Room</button>
          <button id="reset">Reset Buzz</button>
        </div>
      </div>
      <p class="small" id="status"></p>
    </div>

    <div class="card" id="live" style="display:none;">
      <p class="small">First buzz:</p>
      <div class="big" id="winner">—</div>
      <p class="small" id="lockInfo"></p>

      <hr/>

      <h2>Scores</h2>
      <div id="scoreboard"></div>
      <p class="small">Teams appear here automatically when they join.</p>

      <hr/>

      <h2>Charades (Sherards)</h2>
      <div class="row">
        <div class="col">
          <label>Acting team</label><br/>
          <select id="actorTeam"></select>
        </div>
        <div class="col">
          <label>Seconds</label><br/>
          <input id="charadesSeconds" type="number" value="60" min="10" />
        </div>
      </div>

      <div class="row">
        <button id="startCharadesBtn">Start</button>
        <button id="stopCharadesBtn">Stop</button>
        <button id="revealCharadesBtn">Reveal</button>
      </div>

      <p class="small" id="charadesInfo"></p>
      <div class="big" id="charadesTimer" style="display:none;">60</div>
      <p class="small" id="charadesReveal" style="display:none;"></p>

      <hr/>

      <h3>Award points (Charades)</h3>
      <div class="row">
        <div class="col">
          <label>Award to team</label><br/>
          <select id="awardTeam"></select>
        </div>
        <div class="col" style="display:flex; gap:8px; justify-content:flex-end;">
          <button id="awardMinus1">-1</button>
          <button id="awardPlus1">+1</button>
          <button id="awardPlus2">+2</button>
        </div>
      </div>
      <p class="small">Tip: set this to the guessing team that got it right, or just the acting team if you prefer.</p>
    </div>
  </div>

  <script type="module">
    import {
      ensureRoom,
      listenRoom,
      resetBuzz,
      changeScore,
      startCharades,
      stopCharades,
      revealCharades
    } from "./common.js";

    const $ = (id) => document.getElementById(id);

    let roomId = null;
    let unsub = null;

    // latest snapshot state (fixes Stop/Reveal UI issues)
    let latestData = null;

    // You can replace these later with your real charades list
    const CHARADES_NAMES = [
      "David Beckham",
      "Taylor Swift",
      "Harry Potter",
      "Mr Bean",
      "Elvis Presley",
      "James Bond",
      "Mario",
      "Beyoncé",
      "The Grinch",
      "Santa Claus"
    ];
    let charadesIndex = 0;

    function renderScores(teams = [], scores = {}) {
      const box = $("scoreboard");
      box.innerHTML = "";

      if (!teams.length) {
        box.innerHTML = "<p class='small'>No teams yet.</p>";
        $("actorTeam").innerHTML = "";
        $("awardTeam").innerHTML = "";
        return;
      }

      // Populate dropdowns (actor + award)
      $("actorTeam").innerHTML = teams.map(t => `<option value="${t}">${t}</option>`).join("");
      $("awardTeam").innerHTML = teams.map(t => `<option value="${t}">${t}</option>`).join("");

      teams.forEach((team) => {
        const score = Number(scores[team] ?? 0);

        const row = document.createElement("div");
        row.className = "row";
        row.style.alignItems = "center";

        row.innerHTML = `
          <div class="col"><strong>${team}</strong> <span class="small">(${score})</span></div>
          <div class="col" style="display:flex; gap:8px; justify-content:flex-end;">
            <button data-d="-2">-2</button>
            <button data-d="-1">-1</button>
            <button data-d="1">+1</button>
            <button data-d="2">+2</button>
          </div>
        `;

        row.querySelectorAll("button").forEach((btn) => {
          btn.onclick = async () => {
            const delta = Number(btn.getAttribute("data-d"));
            await changeScore(roomId, team, delta);
          };
        });

        box.appendChild(row);
      });
    }

    function renderCharades(data) {
      const round = data?.game?.round ?? null;
      const ch = data?.charades ?? null;

      if (round !== "charades" || !ch) {
        $("charadesInfo").textContent = "Not running.";
        $("charadesTimer").style.display = "none";
        $("charadesReveal").style.display = "none";
        return;
      }

      $("charadesInfo").textContent = ch.actorTeam
        ? `Acting team: ${ch.actorTeam}`
        : "Pick an acting team and press Start.";

      // Timer (always based on latestData — no stale snapshots)
      $("charadesTimer").style.display = "block";
      if (ch.running && typeof ch.endsAt === "number") {
        const remaining = Math.max(0, Math.ceil((ch.endsAt - Date.now()) / 1000));
        $("charadesTimer").textContent = String(remaining);
      } else {
        $("charadesTimer").textContent = "0";
      }

      // Reveal
      if (ch.revealed) {
        $("charadesReveal").style.display = "block";
        $("charadesReveal").textContent = `Answer: ${ch.person ?? "—"}`;
      } else {
        $("charadesReveal").style.display = "none";
      }
    }

    // Timer tick (updates only display — Firestore is source of truth)
    setInterval(() => {
      if (latestData) renderCharades(latestData);
    }, 200);

    $("open").onclick = async () => {
      roomId = $("room").value.trim();
      if (!roomId) {
        $("status").textContent = "Enter a room code.";
        return;
      }

      $("status").textContent = "Opening room…";
      await ensureRoom(roomId);

      $("live").style.display = "block";
      $("status").textContent = `Room ready: ${roomId}`;

      if (unsub) unsub();
      unsub = listenRoom(roomId, (data) => {
        latestData = data;

        const lockedBy = data?.buzz?.lockedBy ?? null;
        $("winner").textContent = lockedBy ? lockedBy : "—";
        $("lockInfo").textContent = lockedBy
          ? "Buzz is locked. Reset to continue."
          : "Buzz is open.";

        renderScores(data?.teams || [], data?.scores || {});
        renderCharades(data);

        // Helpful default: when charades is active, set award dropdown to acting team
        if (data?.game?.round === "charades" && data?.charades?.actorTeam) {
          const actor = data.charades.actorTeam;
          if ([...$("awardTeam").options].some(o => o.value === actor)) {
            $("awardTeam").value = actor;
          }
        }
      });
    };

    $("reset").onclick = async () => {
      if (!roomId) return;
      await resetBuzz(roomId);
    };

    $("startCharadesBtn").onclick = async () => {
      if (!roomId) return;

      const actorTeam = $("actorTeam").value;
      const seconds = Number($("charadesSeconds").value || 60);
      if (!actorTeam) {
        alert("No teams yet — ask teams to join first.");
        return;
      }

      const person = CHARADES_NAMES[charadesIndex % CHARADES_NAMES.length];
      charadesIndex++;

      await startCharades(roomId, actorTeam, person, seconds);

      // default awarding to the acting team (you can change it)
      $("awardTeam").value = actorTeam;
    };

    $("stopCharadesBtn").onclick = async () => {
      if (!roomId) return;
      await stopCharades(roomId);
    };

    $("revealCharadesBtn").onclick = async () => {
      if (!roomId) return;
      await revealCharades(roomId);
    };

    // Award points buttons
    $("awardMinus1").onclick = async () => {
      if (!roomId) return;
      const team = $("awardTeam").value;
      if (!team) return;
      await changeScore(roomId, team, -1);
    };

    $("awardPlus1").onclick = async () => {
      if (!roomId) return;
      const team = $("awardTeam").value;
      if (!team) return;
      await changeScore(roomId, team, 1);
    };

    $("awardPlus2").onclick = async () => {
      if (!roomId) return;
      const team = $("awardTeam").value;
      if (!team) return;
      await changeScore(roomId, team, 2);
    };
  </script>
</body>
</html>
